@inject IUserSession Session
@code {
    [Parameter] public GameModel Model { get; set; }
    [CascadingParameter] public Executor Dispatch { get; set; }
    bool IsActivePlayer => Session.Username.Equals(Model.ActivePlayer);
}

<div class="game-view">
    <div style="grid-area: event-log" class="game-view__events">
        <VerticalLog>
            <RichText Model="@(new TextModel.Paras { Children = Model.EventLog.ToArray() })"/>
        </VerticalLog>
    </div>

    <GridSeparator Area="left-bar"/>

    <div style="grid-area: board" class="game-view__board">
        <div style="grid-area: kingdom" class="game-view__kingdom">
            <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="Estate" />
            <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="Duchy" />
            <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="Province" />

            @if (Model.IsStarted)
            {
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[0]" />
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[1]" />
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[2]" />
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[3]" />
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[4]" />
            }
            else
            {
                <SpecialCard Name="card-back" Half="true" Stack="true" />
                <SpecialCard Name="card-back" Half="true" Stack="true" />
                <SpecialCard Name="card-back" Half="true" Stack="true" />
                <SpecialCard Name="card-back" Half="true" Stack="true" />
                <SpecialCard Name="card-back" Half="true" Stack="true" />
            }

            <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="Copper" />
            <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="Silver" />
            <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="Gold" />

            @if (Model.IsStarted)
            {
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[5]" />
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[6]" />
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[7]" />
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[8]" />
                <ActiveCard Enabled="@IsActivePlayer" Half="true" Stack="true" Id="@Model.KingdomCards[9]" />
            }
            else
            {
                <SpecialCard Name="card-back" Half="true" Stack="true" />
                <SpecialCard Name="card-back" Half="true" Stack="true" />
                <SpecialCard Name="card-back" Half="true" Stack="true" />
                <SpecialCard Name="card-back" Half="true" Stack="true" />
                <SpecialCard Name="card-back" Half="true" Stack="true" />
            }
        </div>

        <div style="grid-area: actions" class="game-view__actions">
            <GappedRow>
                @if (Model.IsStarted)
                {
                    <ActiveCard Large="true" Id="Village" />
                    <ActiveCard Large="true" Id="Market" />
                }
                else
                {                
                    @if (!Model.Players.Contains(Session.Username) && Model.Players.Length < 4)
                    {
                        <ActiveButton Label="Join game" Action="@(() => Dispatch(new JoinGameCommand()))" />
                    }
                    else
                    {
                        @if (Model.Players.Length > 1)
                        {
                            <ActiveButton Label="Start game" Action="@(() => Dispatch(new StartGameCommand()))" />
                        }
                        <ActiveButton Label="Leave game" Action="@(() => Dispatch(new LeaveGameCommand()))" />
                    }
                }
            </GappedRow>
        </div>

        <div style="grid-area: hand">
            <GappedRow>
                @if (Model.IsStarted)
                {
                    <ActiveCard Enabled="@IsActivePlayer" Id="Copper" />
                    <ActiveCard Enabled="@IsActivePlayer" Id="Copper" />
                    <ActiveCard Enabled="@IsActivePlayer" Id="Copper" />
                    <ActiveCard Enabled="@IsActivePlayer" Id="Estate" />
                    <ActiveCard Enabled="@IsActivePlayer" Id="Estate" />
                }
                else
                {
                    <SpecialCard Name="card-back" />
                    <SpecialCard Name="card-back" />
                    <SpecialCard Name="card-back" />
                    <SpecialCard Name="card-back" />
                    <SpecialCard Name="card-back" />
                }
            </GappedRow>
        </div>

        <div style="grid-area: discard">
            <SpecialCard Name="trash" />
        </div>

        <div style="grid-area: deck">
            <SpecialCard Name="card-back" Stack="true" />
        </div>
    </div>

    <GridSeparator Area="right-bar"/>

    <div style="grid-area: status" class="game-view__status">
        @if (Model.Players.Any())
        {
            <span>@(Model.IsStarted ? "Game in progress." : "Waiting to start.") Current players: @string.Join(", ", Model.Players).</span>
        }
        else
        {
            <span>@(Model.IsStarted ? "Game in progress." : "Waiting to start.") No players.</span>
        }
    </div>

    <ChatView Model="@Model.ChatLog" />
</div>