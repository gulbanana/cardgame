@using System.Collections.Concurrent
@typeparam T
@implements IDisposable
@code {
    [Parameter] public IEndpoint<T> Endpoint { get; set; }
    [Parameter] public RenderFragment<T> ChildContent { get; set; }
    [Parameter] public Func<T, T, bool> IsNewer { get; set; }
    private ConcurrentQueue<T> updates;
    private T currentModel;

    protected override void OnInitialized()
    {        
        updates = new ConcurrentQueue<T>();
        currentModel = Endpoint.Subscribe(OnUpdate);
    }

    private void OnUpdate(T newModel)
    {
        updates.Enqueue(newModel);
        InvokeAsync(() =>
        {
            var any = false;
            while (updates.TryDequeue(out var updatedModel))
            {
                if (IsNewer == null || IsNewer(updatedModel, currentModel))
                {
                    any = true;
                    currentModel = updatedModel;
                }
            }
            if (any) StateHasChanged();
        });
    }

    public void Dispose()
    {
        Endpoint.Unsubscribe(OnUpdate);
    }
}

@ChildContent(currentModel)