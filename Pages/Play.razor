@page "/play/{GameName}"
@inject NavigationManager Navigation
@inject IGameEndpoint Endpoint
@inject IUserSession Session
@code {
    [Parameter] public string GameName { get; set; }
    private IGame game;
    private GameModel currentModel;

    protected override void OnInitialized()
    {
        if (Session.IsLoggedIn)
        {
            game = Endpoint.FindGame(GameName);
            currentModel = game.Subscribe(OnUpdate);
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (!Session.IsLoggedIn)
        {
            Navigation.NavigateTo("/");
        }
    }

    private void OnUpdate(GameModel newModel)
    {
        InvokeAsync(() =>
        {
            currentModel = newModel;
            StateHasChanged();
        });
    }

    private void DoExecute(ClientCommand command)
    {
        command.Seq = currentModel.Seq;
        var error = game.Execute(Session.Username, command);

        if (error != null)
        {
            Console.WriteLine(error);
        }
    }
}

@if (Session.IsLoggedIn)
{
    <CascadingValue Value="@(new Executor(DoExecute))">
        <GameView Model="currentModel" />
    </CascadingValue>
}
else
{
    <p>Logging in...</p>
}